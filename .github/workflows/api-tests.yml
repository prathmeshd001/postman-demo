name: API Tests (Postman + Newman)

on:
    push:
    pull_request:

jobs:
    newman:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - run: npm ci

            - name: Start API
              run: |
                  node server.js > server.log 2>&1 &
                  # Wait until an endpoint that returns 200 is up
                  npx wait-on --timeout 60000 http-get://localhost:3000/products
                  # Make the run deterministic
                  curl -sSf -X POST http://localhost:3000/__reset > /dev/null

            - name: Smoke check
              run: curl -sSf http://localhost:3000/products?limit=1 | jq .

            - name: Run Newman with HTML report
              run: |
                  mkdir -p reports
                  npm run test:api

            - name: Upload HTML report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: newman-report
                  path: reports/

            - name: Print server logs on failure
              if: failure()
              run: |
                  echo "===== server.log ====="
                  cat server.log
